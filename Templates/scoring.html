<script>

    // Game session variable - active or not 
let isGameSessionActive = false;



// Function to enable or disable the "Score" buttons
function toggleScoreButtons(enabled) {
    const addScoreButton = document.getElementById("generateCardButton");
    const addPassButton = document.getElementById("nextCardButton")
    addScoreButton.disabled = !enabled;
    addPassButton.disabled = !enabled;
}




// starting game state; turning on score buttons
function startTurnSession() {
    isGameSessionActive = true;
    toggleScoreButtons(true); // Enable the "Score" buttons
}




// ending game state; disabling score buttons
function endTurnSession() {
    isGameSessionActive = false;
    toggleScoreButtons(false); // Disable the "Score" buttons
}





// Adding a pass - pass listener and call
document.getElementById("nextCardButton").addEventListener("click", function() {
    if (isGameSessionActive) {
        updatePassScore();
        generateRandomCard();
    } else {
        // Game session is not active, do nothing or display a message
        console.log("Game session is not active. Cannot add score.");
    }
});




// Pass score incrementation function
function updatePassScore() {
// Get the current player's name and pass score elements
const currentPlayerElement = document.getElementById("currentPlayer");
const passScoreElement = document.getElementById("passScore");



// Extract the current player's name
const currentPlayer = currentPlayerElement.textContent;

// Retrieve the current pass score from the pass score element
let passScore = parseInt(passScoreElement.textContent.replace("Passes: ", ""));

// Increment the pass score
passScore += 1;

// Update the pass score element with the new score
passScoreElement.textContent = "Passes: " + passScore;

// Send the updated pass score to the server
fetch("/update-pass-score", {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
    },
    body: JSON.stringify({
        current_player: currentPlayer,
        pass_score: passScore,  // Send the updated pass score
    }),
})
    .then(response => response.json())
    .then(data => {
        // Handle the response from the server if needed
    })
    .catch(error => {
        console.error("Error updating pass score:", error);
    });
    updatePlayerScores(); // Update the table
}




// Adding a score - correct score listener and call
document.getElementById("generateCardButton").addEventListener("click", function() {
    if (isGameSessionActive) {
        updateCorrectScore();
        generateRandomCard();
    } else {
        // Game session is not active, do nothing or display a message
        console.log("Game session is not active. Cannot add score.");
    }
});




// Function to add correct score incrementation function  
function updateCorrectScore() {
// Get the current player's name and score elements
const currentPlayerElement = document.getElementById("currentPlayer");
const correctScoreElement = document.getElementById("correctScore");


// Extract the current player's name
const currentPlayer = currentPlayerElement.textContent;

// Retrieve the current score from the score element
let score = parseInt(correctScoreElement.textContent.replace("Correct: ", ""));

// Increment the score (you can change this logic as needed)
score += 1;  // For example, adding 10 points

// Update the score element with the new score
correctScoreElement.textContent = "Correct: " + score;

// Send the updated score to the server
fetch("/update-correct-score", {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
    },
    body: JSON.stringify({
        current_player: currentPlayer,
        correct_score: score,  // Send the updated score
    }),
})
    .then(response => response.json())
    .then(data => {
        // Handle the response from the server if needed
    })
    .catch(error => {
        console.error("Error updating score:", error);
    });

    
    updatePlayerScores(); // Update the table
}



// Function to update the table with player scores
function updatePlayerScores() {
  // Get the current player's name and scores
  const currentPlayerElement = document.getElementById("currentPlayer");
  const correctScoreElement = document.getElementById("correctScore");
  const passScoreElement = document.getElementById("passScore");

  const currentPlayer = currentPlayerElement.textContent.replace("Current Player: ", ""); // Extract just the player name
  const correctScore = parseInt(correctScoreElement.textContent.replace("Correct: ", ""));
  const passScore = parseInt(passScoreElement.textContent.replace("Passes: ", ""));

  // Find an existing row for the current player, if it exists
  const tableBody = document.getElementById("scoreTableBody");
  const rows = tableBody.getElementsByTagName("tr");
  let existingRow = null;

  for (const row of rows) {
    if (row.cells[0].textContent === currentPlayer) {
      existingRow = row;
      break;
    }
  }

  if (existingRow) {
    // Update the existing row's pass and correct scores
    existingRow.cells[1].textContent = passScore;
    existingRow.cells[2].textContent = correctScore;
  } else {
    // Create a new table row with player scores
    const newRow = document.createElement("tr");
    newRow.innerHTML = `
      <td>${currentPlayer}</td>
      <td>${passScore}</td>
      <td>${correctScore}</td>
    `;

    // Append the new row to the table
    tableBody.appendChild(newRow);
  }
}




// Function to fetch the next player
function getNextPlayer() {
    // Make a POST request to the '/next-player' route
    fetch('/next-player', {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        if (data.current_player) {
            document.getElementById("currentPlayer").textContent = "Current Player: " + data.current_player;
            
            if (data.next_player) {
                // Check if the next player is in the same team as the current player
                const currentTeam = getTeam(data.current_player);
                const nextPlayerTeam = getTeam(data.next_player);

                if (currentTeam && nextPlayerTeam && currentTeam === nextPlayerTeam) {
                    // If they are in the same team, make another request to get a different next player
                    getNextPlayer();
                } else {
                    document.getElementById("nextPlayer").textContent = "Next Player: " + data.next_player;
                }
            } else {
                document.getElementById("nextPlayer").textContent = data.current_player + ", you are the last player!";
            }
        } else {
            document.getElementById("nextPlayer").textContent = "No more players. Game over.";
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}



// Function to get the team of a player
function getTeam(player) {
    // Make a fetch API request to get the team data
    fetch('/get-session-data')  
        .then(response => response.json())
        .then(data => {
            // Check if the player is in any of the teams
            for (const team in data.team_data) {
                if (data.team_data.hasOwnProperty(team) && data.team_data[team].includes(player)) {
                    return team;
                }
            }
            return null;  // Player not found in any team
        })
        .catch(error => {
            console.error('Error fetching team data:', error);
            return null;
        });
}






// Function to start the first player's turn
function startFirstPlayerTurn() {
    // Make a POST request to the '/next-player' route to get the first player
    fetch('/next-player', {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        if (data.current_player) {
            document.getElementById("currentPlayer").textContent = "Current Player: " + data.current_player;
            if (data.next_player) {
                document.getElementById("nextPlayer").textContent = "Next Player: " + data.next_player;
            } else {
                document.getElementById("nextPlayer").textContent = "No more players. Final turn for " + data.current_player;
                
            }
        } else {
            document.getElementById("nextPlayer").textContent = "No more players. Game over.";
            
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}



    // Function to generate a random card
    function generateRandomCard() {
    fetch('/generate_random_card', {
        method: 'GET',
    })
    .then(response => response.json())
    .then(data => {
        // Update the content of the flashcard attributes with the retrieved card data
        document.getElementById('keyWord').textContent = data.key_word_category;
        document.getElementById('keyCharacter').textContent = data.key_character_category;
        document.getElementById('examSkills').textContent = data.exam_skills_category;
        document.getElementById('grammarRules').textContent = data.grammar_rules_category;
        document.getElementById('spellings').textContent = data.spellings_category;
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

</script>


